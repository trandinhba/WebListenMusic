@model Song
@{
    ViewData["Title"] = Model.Title;
    var relatedSongs = ViewBag.RelatedSongs as List<Song> ?? new List<Song>();
}

<div class="song-detail-page">
    <!-- Song Header -->
    <div class="song-header">
        <div class="song-cover-large">
            <img src="@(Model.CoverImageUrl ?? "/images/default-song.svg")" alt="@Model.Title" onerror="this.src='/images/default-song.svg';" />
            <button class="play-btn-large" onclick="playSong(@Model.Id)">
                <i class="bi bi-play-fill"></i>
            </button>
        </div>
        <div class="song-header-info">
            <span class="content-type">Song</span>
            <h1>@Model.Title</h1>
            <div class="song-meta-info">
                @if (Model.Artist != null)
                {
                    <a asp-controller="Artists" asp-action="Details" asp-route-id="@Model.ArtistId" class="artist-link">
                        <img src="@(Model.Artist.ImageUrl ?? "/images/default-artist.svg")" alt="@Model.Artist.Name" onerror="this.src='/images/default-artist.svg';" />
                        @Model.Artist.Name
                        @if (Model.Artist.IsVerified)
                        {
                            <i class="bi bi-patch-check-fill text-info"></i>
                        }
                    </a>
                }
                @if (Model.Album != null)
                {
                    <span class="separator">•</span>
                    <a asp-controller="Albums" asp-action="Details" asp-route-id="@Model.AlbumId">@Model.Album.Title</a>
                }
                @if (Model.Genre != null)
                {
                    <span class="separator">•</span>
                    <a asp-controller="Songs" asp-action="Index" asp-route-genre="@Model.GenreId">@Model.Genre.Name</a>
                }
            </div>
            <div class="song-stats">
                <span><i class="bi bi-play-circle"></i> @Model.PlayCount.ToString("N0") plays</span>
                <span><i class="bi bi-heart-fill"></i> @Model.LikeCount.ToString("N0") likes</span>
                <span><i class="bi bi-clock"></i> @FormatDuration(Model.Duration)</span>
                @if (Model.ReleaseDate.HasValue)
                {
                    <span><i class="bi bi-calendar3"></i> @Model.ReleaseDate.Value.ToString("dd/MM/yyyy")</span>
                }
            </div>
            <div class="song-actions-main">
                <button class="btn btn-primary btn-lg" onclick="playSong(@Model.Id)">
                    <i class="bi bi-play-fill me-2"></i>Play Now
                </button>
                <button class="btn btn-outline-light" onclick="toggleLike(@Model.Id)" id="likeBtn">
                    <i class="bi bi-heart me-2"></i>Favorite
                </button>
                <button class="btn btn-outline-light" onclick="addToPlaylist(@Model.Id)">
                    <i class="bi bi-plus-lg me-2"></i>Playlist
                </button>
                <div class="dropdown d-inline-block">
                    <button class="btn btn-outline-light" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#" onclick="playNext(@Model.Id)"><i class="bi bi-skip-end"></i> Play Next</a></li>
                        <li><a class="dropdown-item" href="#" onclick="addToQueue(@Model.Id)"><i class="bi bi-list-ul"></i> Add to Queue</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="shareSong(@Model.Id)"><i class="bi bi-share"></i> Share</a></li>
                        <li><a class="dropdown-item" href="#" onclick="reportSong(@Model.Id)"><i class="bi bi-flag"></i> Report</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Lyrics Section -->
        <div class="col-lg-7">
            @if (!string.IsNullOrEmpty(Model.Lyrics))
            {
                <div class="lyrics-section">
                    <h3><i class="bi bi-music-note-list me-2"></i>Lyrics</h3>
                    <div class="lyrics-content" id="lyricsContent">
                        @Html.Raw(Model.Lyrics.Replace("\n", "<br/>"))
                    </div>
                    <button class="btn btn-link" id="expandLyrics" onclick="toggleLyrics()">
                        Show More <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
            }
            else
            {
                <div class="lyrics-section">
                    <h3><i class="bi bi-music-note-list me-2"></i>Lyrics</h3>
                    <p class="text-muted">No lyrics available</p>
                </div>
            }
        </div>

        <!-- Related Songs -->
        <div class="col-lg-5">
            @if (relatedSongs.Any())
            {
                <div class="related-section">
                    <h3><i class="bi bi-music-note-beamed me-2"></i>Related Songs</h3>
                    <div class="related-list">
                        @foreach (var song in relatedSongs)
                        {
                            <div class="related-item" data-song-id="@song.Id">
                                <div class="related-cover">
                                    <img src="@(song.CoverImageUrl ?? "/uploads/covers/default-song.jpg")" alt="@song.Title" />
                                    <button class="play-btn-sm" onclick="playSong(@song.Id)">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                </div>
                                <div class="related-info">
                                    <h5><a asp-action="Details" asp-route-id="@song.Id">@song.Title</a></h5>
                                    <p>@(song.Artist?.Name ?? "Unknown")</p>
                                </div>
                                <span class="duration">@FormatDuration(song.Duration)</span>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (Model.Artist != null)
            {
                <div class="artist-section">
                    <h3><i class="bi bi-person me-2"></i>About the Artist</h3>
                    <a asp-controller="Artists" asp-action="Details" asp-route-id="@Model.ArtistId" class="artist-card-detail">
                        <img src="@(Model.Artist.ImageUrl ?? "/uploads/artists/default-artist.jpg")" alt="@Model.Artist.Name" />
                        <div>
                            <h4>
                                @Model.Artist.Name
                                @if (Model.Artist.IsVerified)
                                {
                                    <i class="bi bi-patch-check-fill text-info"></i>
                                }
                            </h4>
                            <p>@Model.Artist.Songs?.Count() songs</p>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- Rating & Comments Row -->
    <div class="row mt-4">
        <!-- Rating Section -->
        <div class="col-lg-4">
            <div class="rating-section">
                <h3><i class="bi bi-star me-2"></i>Rating</h3>
                <div class="rating-display">
                    <div class="rating-average">
                        <span class="rating-number" id="avgRating">0</span>
                        <div class="rating-stars" id="avgStars">
                            <i class="bi bi-star text-warning"></i>
                            <i class="bi bi-star text-warning"></i>
                            <i class="bi bi-star text-warning"></i>
                            <i class="bi bi-star text-warning"></i>
                            <i class="bi bi-star text-warning"></i>
                        </div>
                        <span class="rating-count">(<span id="totalRatings">0</span> ratings)</span>
                    </div>
                    
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="user-rating">
                            <p class="mb-2">Your rating:</p>
                            <div class="star-rating" id="userRating">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <button class="star-btn" data-rating="@i">
                                        <i class="bi bi-star"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mt-3">
                            <a asp-controller="Account" asp-action="Login">Login</a> to rate this song
                        </p>
                    }
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="col-lg-8">
            <div class="comments-section">
                <h3><i class="bi bi-chat-dots me-2"></i>Comments (<span id="commentCount">0</span>)</h3>
                
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="comment-form">
                        <div class="comment-input-wrapper">
                            <img src="/images/default-avatar.svg" alt="Avatar" class="comment-avatar" />
                            <textarea id="commentInput" class="form-control" 
                                      placeholder="Write a comment..." maxlength="1000"></textarea>
                        </div>
                        <div class="comment-form-actions">
                            <span class="char-count"><span id="charCount">0</span>/1000</span>
                            <button class="btn btn-primary btn-sm" id="btnPostComment">
                                <i class="bi bi-send me-1"></i>Post
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted mb-3">
                        <a asp-controller="Account" asp-action="Login">Login</a> to leave a comment
                    </p>
                }
                
                <div class="comments-list" id="commentsList">
                    <!-- Comments will be loaded by JS -->
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="comments-pagination mt-3" id="commentsPagination">
                    <!-- Pagination will be rendered by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .song-detail-page {
        padding-bottom: 40px;
    }
    
    .song-header {
        display: flex;
        gap: 32px;
        margin-bottom: 40px;
        padding-bottom: 32px;
        border-bottom: 1px solid var(--ml-border);
    }
    
    .song-cover-large {
        position: relative;
        width: 280px;
        height: 280px;
        flex-shrink: 0;
    }
    
    .song-cover-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--ml-radius-lg);
        box-shadow: var(--ml-shadow-lg);
    }
    
    .play-btn-large {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--ml-primary);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        box-shadow: var(--ml-shadow-lg);
        transition: var(--ml-transition);
    }
    
    .play-btn-large:hover {
        transform: scale(1.1);
    }
    
    .song-header-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .content-type {
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--ml-text-muted);
        margin-bottom: 8px;
    }
    
    .song-header-info h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 16px;
    }
    
    .song-meta-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .artist-link {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--ml-text);
        font-weight: 500;
    }
    
    .artist-link img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .separator {
        color: var(--ml-text-muted);
    }
    
    .song-stats {
        display: flex;
        gap: 24px;
        font-size: 0.875rem;
        color: var(--ml-text-muted);
        margin-bottom: 24px;
    }
    
    .song-stats span {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .song-actions-main {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .lyrics-section, .related-section, .artist-section {
        background: var(--ml-surface);
        border-radius: var(--ml-radius-lg);
        padding: 24px;
        margin-bottom: 24px;
    }
    
    .lyrics-section h3, .related-section h3, .artist-section h3 {
        font-size: 1.125rem;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
    }
    
    .lyrics-content {
        color: var(--ml-text-muted);
        line-height: 1.8;
        max-height: 300px;
        overflow: hidden;
        position: relative;
    }
    
    .lyrics-content.expanded {
        max-height: none;
    }
    
    .related-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .related-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px;
        border-radius: var(--ml-radius);
        transition: var(--ml-transition);
    }
    
    .related-item:hover {
        background: var(--ml-surface-hover);
    }
    
    .related-cover {
        position: relative;
        width: 48px;
        height: 48px;
        flex-shrink: 0;
    }
    
    .related-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--ml-radius);
    }
    
    .related-info {
        flex: 1;
        min-width: 0;
    }
    
    .related-info h5 {
        font-size: 0.875rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .related-info h5 a {
        color: var(--ml-text);
    }
    
    .related-info p {
        font-size: 0.75rem;
        color: var(--ml-text-muted);
        margin: 0;
    }
    
    .duration {
        font-size: 0.75rem;
        color: var(--ml-text-muted);
    }
    
    .artist-card-detail {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px;
        border-radius: var(--ml-radius);
        transition: var(--ml-transition);
        text-decoration: none;
        color: var(--ml-text);
    }
    
    .artist-card-detail:hover {
        background: var(--ml-surface-hover);
    }
    
    .artist-card-detail img {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .artist-card-detail h4 {
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .artist-card-detail p {
        font-size: 0.875rem;
        color: var(--ml-text-muted);
        margin: 0;
    }
    
    @@media (max-width: 768px) {
        .song-header {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .song-cover-large {
            width: 200px;
            height: 200px;
        }
        
        .song-header-info h1 {
            font-size: 1.75rem;
        }
        
        .song-meta-info, .song-stats, .song-actions-main {
            justify-content: center;
        }
    }

    /* Rating Section Styles */
    .rating-section, .comments-section {
        background: var(--ml-surface);
        border-radius: var(--ml-radius-lg);
        padding: 24px;
        margin-bottom: 24px;
    }

    .rating-section h3, .comments-section h3 {
        font-size: 1.125rem;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
    }

    .rating-display {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .rating-average {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .rating-number {
        font-size: 3rem;
        font-weight: 700;
        color: var(--ml-text);
    }

    .rating-stars {
        display: flex;
        gap: 4px;
        font-size: 1.25rem;
    }

    .rating-count {
        color: var(--ml-text-muted);
        font-size: 0.875rem;
    }

    .user-rating {
        padding-top: 16px;
        border-top: 1px solid var(--ml-border);
    }

    .star-rating {
        display: flex;
        gap: 8px;
    }

    .star-btn {
        background: none;
        border: none;
        font-size: 1.75rem;
        color: var(--ml-text-muted);
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 4px;
    }

    .star-btn:hover,
    .star-btn.active {
        color: #ffc107;
        transform: scale(1.1);
    }

    .star-btn i {
        transition: all 0.2s ease;
    }

    /* Comments Section Styles */
    .comment-form {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--ml-border);
    }

    .comment-input-wrapper {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .comment-form textarea {
        resize: none;
        min-height: 80px;
        background: var(--ml-bg);
        border-color: var(--ml-border);
        color: var(--ml-text);
    }

    .comment-form textarea:focus {
        background: var(--ml-bg);
        border-color: var(--ml-primary);
        color: var(--ml-text);
        box-shadow: 0 0 0 0.2rem rgba(var(--ml-primary-rgb), 0.25);
    }

    .comment-form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .char-count {
        font-size: 0.875rem;
        color: var(--ml-text-muted);
    }

    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .comment-item {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: var(--ml-bg);
        border-radius: var(--ml-radius);
    }

    .comment-content {
        flex: 1;
        min-width: 0;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .comment-author {
        font-weight: 600;
        color: var(--ml-text);
    }

    .comment-time {
        font-size: 0.8125rem;
        color: var(--ml-text-muted);
    }

    .comment-edited {
        font-size: 0.75rem;
        color: var(--ml-text-muted);
        font-style: italic;
    }

    .comment-text {
        color: var(--ml-text);
        margin-bottom: 8px;
        line-height: 1.6;
        word-wrap: break-word;
    }

    .comment-actions {
        display: flex;
        gap: 12px;
    }

    .comment-actions .btn-link {
        padding: 0;
        font-size: 0.8125rem;
        text-decoration: none;
    }

    .comments-empty {
        text-align: center;
        padding: 32px;
        color: var(--ml-text-muted);
    }

    .comments-empty i {
        font-size: 3rem;
        margin-bottom: 16px;
        display: block;
    }
</style>

@section Scripts {
    <script>
        const songId = @Model.Id;
        let currentUserRating = 0;
        let currentCommentPage = 1;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRating(songId);
            loadComments(songId);
            initRatingStars();
            initCommentForm();
        });

        function toggleLyrics() {
            const content = document.getElementById('lyricsContent');
            const btn = document.getElementById('expandLyrics');
            content.classList.toggle('expanded');
            if (content.classList.contains('expanded')) {
                btn.innerHTML = 'Show Less <i class="bi bi-chevron-up"></i>';
            } else {
                btn.innerHTML = 'Show More <i class="bi bi-chevron-down"></i>';
            }
        }

        // ========== RATING FUNCTIONS ==========
        async function loadRating(songId) {
            try {
                const response = await fetch(`/Songs/GetRating/${songId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateRatingDisplay(data);
                }
            } catch (err) {
                console.error('Error loading rating:', err);
            }
        }

        function updateRatingDisplay(data) {
            document.getElementById('avgRating').textContent = data.averageRating.toFixed(1);
            document.getElementById('totalRatings').textContent = data.totalRatings;
            
            // Render average stars
            const avgStars = document.getElementById('avgStars');
            avgStars.innerHTML = renderStars(data.averageRating);
            
            // Update user rating if exists
            if (data.userRating) {
                currentUserRating = data.userRating;
                highlightUserStars(data.userRating);
            }
        }

        function renderStars(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    html += '<i class="bi bi-star-fill text-warning"></i>';
                } else if (i - 0.5 <= rating) {
                    html += '<i class="bi bi-star-half text-warning"></i>';
                } else {
                    html += '<i class="bi bi-star text-warning"></i>';
                }
            }
            return html;
        }

        function highlightUserStars(rating) {
            const stars = document.querySelectorAll('#userRating .star-btn');
            stars.forEach((star, index) => {
                const icon = star.querySelector('i');
                if (index < rating) {
                    icon.classList.remove('bi-star');
                    icon.classList.add('bi-star-fill');
                    star.classList.add('active');
                } else {
                    icon.classList.remove('bi-star-fill');
                    icon.classList.add('bi-star');
                    star.classList.remove('active');
                }
            });
        }

        function initRatingStars() {
            const stars = document.querySelectorAll('#userRating .star-btn');
            stars.forEach((star, index) => {
                star.addEventListener('mouseenter', () => highlightUserStars(index + 1));
                star.addEventListener('mouseleave', () => highlightUserStars(currentUserRating));
                star.addEventListener('click', () => rateSong(songId, index + 1));
            });
        }

        async function rateSong(songId, rating) {
            try {
                const response = await fetch('/Songs/Rate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ songId, rating })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentUserRating = rating;
                        updateRatingDisplay(data);
                        showToast('Rating saved!', 'success');
                    } else {
                        showToast(data.message, 'warning');
                    }
                }
            } catch (err) {
                console.error('Error rating song:', err);
                showToast('Error saving rating', 'error');
            }
        }

        // ========== COMMENT FUNCTIONS ==========
        async function loadComments(songId, page = 1) {
            try {
                const response = await fetch(`/Songs/GetComments/${songId}?page=${page}`);
                if (response.ok) {
                    const data = await response.json();
                    renderComments(data);
                    currentCommentPage = page;
                }
            } catch (err) {
                console.error('Error loading comments:', err);
            }
        }

        function renderComments(data) {
            document.getElementById('commentCount').textContent = data.totalComments;
            
            const container = document.getElementById('commentsList');
            
            if (data.comments.length === 0) {
                container.innerHTML = `
                    <div class="comments-empty">
                        <i class="bi bi-chat-dots"></i>
                        <p>No comments yet. Be the first to comment!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.comments.map(comment => `
                <div class="comment-item" id="comment-${comment.id}">
                    <img src="${comment.userAvatar || '/images/default-avatar.svg'}" 
                         alt="Avatar" class="comment-avatar" onerror="this.src='/images/default-avatar.svg';" />
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(comment.userName)}</span>
                            <span class="comment-time">${formatTimeAgo(comment.createdAt)}</span>
                            ${comment.isEdited ? '<span class="comment-edited">(edited)</span>' : ''}
                        </div>
                        <p class="comment-text" id="comment-text-${comment.id}">${escapeHtml(comment.content)}</p>
                        ${comment.isOwner ? `
                            <div class="comment-actions">
                                <button class="btn btn-link btn-sm" onclick="editComment(${comment.id})">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-link btn-sm text-danger" onclick="deleteComment(${comment.id})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            // Render pagination
            renderCommentsPagination(data);
        }

        function renderCommentsPagination(data) {
            const container = document.getElementById('commentsPagination');
            if (data.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
            
            for (let i = 1; i <= data.totalPages; i++) {
                html += `
                    <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                        <button class="page-link" onclick="loadComments(${data.songId}, ${i})">${i}</button>
                    </li>
                `;
            }
            
            html += '</ul></nav>';
            container.innerHTML = html;
        }

        function initCommentForm() {
            const input = document.getElementById('commentInput');
            const charCount = document.getElementById('charCount');
            const postBtn = document.getElementById('btnPostComment');
            
            if (input) {
                input.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }
            
            if (postBtn) {
                postBtn.addEventListener('click', () => addComment(songId));
            }
        }

        async function addComment(songId) {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            
            if (!content) {
                showToast('Please enter a comment', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/Songs/AddComment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ songId, content })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        input.value = '';
                        document.getElementById('charCount').textContent = '0';
                        loadComments(songId, 1);
                        showToast('Comment added!', 'success');
                    } else {
                        showToast(data.message, 'warning');
                    }
                }
            } catch (err) {
                console.error('Error adding comment:', err);
                showToast('Error adding comment', 'error');
            }
        }

        async function editComment(commentId) {
            const textEl = document.getElementById(`comment-text-${commentId}`);
            const currentText = textEl.textContent;
            
            const newText = prompt('Edit your comment:', currentText);
            if (newText === null || newText.trim() === currentText) return;
            
            try {
                const response = await fetch('/Songs/EditComment', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: commentId, content: newText.trim() })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        textEl.textContent = newText.trim();
                        showToast('Comment updated!', 'success');
                        loadComments(songId, currentCommentPage);
                    } else {
                        showToast(data.message, 'warning');
                    }
                }
            } catch (err) {
                console.error('Error editing comment:', err);
                showToast('Error editing comment', 'error');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            try {
                const response = await fetch(`/Songs/DeleteComment/${commentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById(`comment-${commentId}`).remove();
                        showToast('Comment deleted!', 'success');
                        loadComments(songId, currentCommentPage);
                    } else {
                        showToast(data.message, 'warning');
                    }
                }
            } catch (err) {
                console.error('Error deleting comment:', err);
                showToast('Error deleting comment', 'error');
            }
        }

        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            
            return date.toLocaleDateString();
        }
    </script>
}

@functions {
    string FormatDuration(int seconds)
    {
        var span = TimeSpan.FromSeconds(seconds);
        return span.Hours > 0 ? span.ToString(@"h\:mm\:ss") : span.ToString(@"m\:ss");
    }
}
